# ===================================================
# Use Node 20 (Strapi v5 compatible)
# ===================================================
FROM node:20-slim

# ===================================================
# Install system dependencies (needed for sqlite)
# ===================================================
RUN apt-get update && apt-get install -y \
    python3 \
    build-essential \
    sqlite3 \
    && rm -rf /var/lib/apt/lists/*

# ===================================================
# Set working directory
# ===================================================
WORKDIR /app

# ===================================================
# Copy package files first (Docker caching optimization)
# ===================================================
COPY package*.json ./

# ===================================================
# Install dependencies (production safe)
# ===================================================
RUN npm install --production

# ===================================================
# Copy full project
# ===================================================
COPY . .

# ===================================================
# Ensure uploads directory exists
# ===================================================
RUN mkdir -p public/uploads

# ===================================================
# Build admin panel (REQUIRED for production)
# ===================================================
RUN npm run build

# ===================================================
# Expose port
# ===================================================
EXPOSE 1337

# ===================================================
# Start Strapi in production
# ===================================================
CMD ["npm", "run", "start"]
